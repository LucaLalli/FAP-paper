# FAP-paper

Code accompanying the manuscript:  
**"A Low-Inflammatory Diet Rewires Metaflammation and Trained Immunity to Reprogram Immune Tone in Early Colorectal Tumorigenesis"**  
(Daveri, Lalli et al., 2025)

---

## 📌 Overview
This repository contains the R code to reproduce the **time-series immunoprofiling analysis** of FAP patients across three timepoints (**PRE, 3M, 6M**).  
The workflow implements standardized data processing, normalization, longitudinal testing, and clustering of cytokines, myeloid, lymphoid, and hematological features using the **CONNECTOR** framework.

---

## 🔐 Data availability & privacy
The data used in this study include **sensitive clinical datasets** and are **not** shared in this repository.  
To run the analysis you must provide a compatible `data` and point the script to it (see below).

If you wish to reproduce the analysis, please contact the corresponding author for data access:
- 📧 Elena.Daveri@istitutotumori.mi.it
- 📧 Licia.Rivoltini@istitutotumori.mi.it
- 📧 Luca.Lalli@istitutotumori.mi.it

---

## ⚙️ Requirements
- **R ≥ 4.2**
- Suggested packages (installed automatically in the script if missing):
  - core data wrangling: `readxl`, `dplyr`, `tidyr`, `stringr`, `purrr`, `zoo`, `scales`, `rstatix`
  - connector & clustering: `connector` (qBioTurin/connector), `missForest`
  - plotting (generated by connector): `ggplot2`, etc.

> If `connector` is not installed, enable the line in the script that calls  
> `remotes::install_github("qBioTurin/connector", ref = "master", dependencies = TRUE)`.

---

## 📁 Input expected by the script
The analysis starts from a **serialized R object** that can be requested from the corresponding authors.  
This object is a **list** with the following elements:

- `data` — main dataset in **sample-by-feature** format with columns:
  - `Id` (patient ID, e.g. FAP01)
  - `Time` (numeric: 0, 3, 6)
  - variables (cytokines, myeloid, lymphoid, hematological markers)
- `name_cytokines`, `name_myeloids`, `name_lymphoids`, `name_emocromos` — character vectors of variable names by family
- `name_timepoints_num` — numeric vector of timepoints (`c(0,3,6)`)
- `name_ptzs` — character vector of patient IDs

---

## ▶️ How to run
1. **Clone** the repository and open R (or RStudio).  
2. **Set** the `FAP_DATA_XLSX` environment variable as above.  
3. **Source** the script:
   ```r
   source("R/FAP_analysis.R")
   ```
4. The script will generate intermediate objects and figures and, where applicable, save outputs under `output/` (if enabled).

---

## 🧪 What the code does
The script performs the following major steps:

1. **Data preparation**  
   - Loads the dataset and defines variable groups (cytokines, myeloid, lymphoid, emocromo).  
   - Rescales all variables to the range [-1, 1] and computes delta vs. baseline (PRE).  

2. **Longitudinal analysis**  
   - Runs Friedman tests across timepoints (0, 3, 6) to identify significantly modulated variables.  
   - Builds CONNECTOR-ready long-format datasets for each variable family.

3. **Time-series clustering (CONNECTOR)**  
   - Imports the merged dataset, determines spline complexity (`p`) and cluster number (`G`).  
   - Runs repeated clustering, consensus analysis, and plots mean trajectories.  

4. **Patient-level integration**  
   - Builds a patient × variable matrix based on CONNECTOR cluster assignments.  
   - Performs imputation with `missForest`.  
   - Computes hierarchical clustering to define meta-clusters (e.g., Cluster X / Y).  

---

## 🖴 Outputs
- Figures from CONNECTOR (curves, consensus, indexes, mean cluster plots).  
- Intermediate tables: `*_conn`, `*_annotation`, merged `data_tot_conn`, `tot_annotation`.  
- Final patient × variable matrix and meta-cluster assignments.

---

## 🔁 Reproducibility
- Fixed seed for imputation: `set.seed(4478432)`  
- Version tracking via `sessionInfo()`  
- Reproducible pipeline using modular sections and consistent naming.

---

## 🧱 Limitations & assumptions
- Only complete patient series (0, 3, 6 months) are used for Friedman tests.  
- Variable names must match those used in the original dataset.  
- Analysis assumes consistent preprocessing and data scaling across patients.

---

## ✒️ Citation
If you use this code, please cite the associated publication:

> Daveri E\*, Lalli L\*, Ferrero G, et al.  
> *A Low-Inflammatory Diet Rewires Metaflammation and Trained Immunity to Reprogram Immune Tone in Early Colorectal Tumorigenesis*. 2025.

---

## 👥 Authors
- **Elena Daveri** – Conceptualization, Writing  
- **Luca Lalli** – Statistical analysis, Code development  
- … (see manuscript for full author list)
